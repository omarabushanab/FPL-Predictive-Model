query_scoring = """
// rule.txt - Complete scoring rule implementation
MATCH (p:Player)-[:PLAYS_AS]->(pos:Position)
WITH p, collect(pos.name) as positions
WHERE size(positions) > 1 AND 'DEF' IN positions

WITH p, positions
MATCH (p)-[played:PLAYED_IN]->(f:Fixture)
MATCH (f)<-[:HAS_FIXTURE]-(gw:Gameweek)-[:HAS_GW]-(s:Season)

// Calculate what the score SHOULD have been if player was defender
WITH p, positions, played, f, s, gw,
     // General scoring rules
     played.assists * 3 +
     CASE 
         WHEN played.minutes < 60 THEN 1
         WHEN played.minutes >= 60 THEN 2
         ELSE 0 
     END +
     COALESCE(played.penalties_missed, 0) * -2 +
     COALESCE(played.own_goals, 0) * -2 +
     COALESCE(played.yellow_cards, 0) * -1 +
     COALESCE(played.red_cards, 0) * -3 +
     
     // Defender-specific scoring
     COALESCE(played.goals_scored, 0) * 6 +
     CASE 
         WHEN played.minutes > 60 AND COALESCE(played.clean_sheets, 0) = 1 THEN 4
         ELSE 0 
     END +
     FLOOR(COALESCE(played.goals_conceded, 0) / 2.0) * -1 +
     // Penalty saves and saves don't apply to defenders (0 points)
     0 as def_score,

     // Store fixture details
     s.season_name as season,
     f.fixture_number as fixture_number,
     played.total_points as total_points

// Check if defender score matches actual points (with small tolerance for floating point)
WITH p, 
     size([played IN [(p)-[played:PLAYED_IN]->(f) | played] WHERE played.minutes > 0]) as total_fixtures,
     collect({
         def_score: def_score,
         season: season,
         fixture_number: fixture_number,
         matches_def: abs(def_score - total_points) < 0.1, // Small tolerance for comparison
         total_points: total_points
     }) as all_fixtures

// Filter only fixtures where defender score doesn't match actual points
WITH p, 
     total_fixtures,
     [fixture IN all_fixtures WHERE NOT fixture.matches_def] as incorrect_fixtures

WHERE size(incorrect_fixtures) > 0
RETURN p.player_name as player,
       size(incorrect_fixtures) as not_def_fixtures,
       total_fixtures,
       incorrect_fixtures as fixture_details
ORDER BY not_def_fixtures DESC
"""

result = conn.execute_query(query_scoring)

# Format the output exactly as specified
print("player\tnot_def_fixtures\ttotal_fixtures\tfixture_details")
print("-" * 80)

for record in result:
    player = record['player']
    not_def_fixtures = record['not_def_fixtures']
    total_fixtures = record['total_fixtures']
    fixture_details = record['fixture_details']
    
    # Print in the exact format with proper spacing
    print(f'"{player}"\t{not_def_fixtures}\t{total_fixtures}')
    print("[")
    
    for i, fixture in enumerate(fixture_details):
        print("  {")
        print(f'    "def_score": {fixture["def_score"]},')
        print(f'    "season": "{fixture["season"]}",')
        print(f'    "fixture_number": {fixture["fixture_number"]},')
        print(f'    "matches_def": {str(fixture["matches_def"]).lower()},')
        print(f'    "total_points": {fixture["total_points"]}')
        print("  }" + ("," if i < len(fixture_details) - 1 else ""))
    
    print("]")
    print()  # Add space between players